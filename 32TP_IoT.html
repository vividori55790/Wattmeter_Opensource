<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT 전력 모니터링</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 적용 */
        body { font-family: 'Inter', sans-serif; }
        /* Tailwind CSS 다크 모드 기본 활성화 */
        :root { color-scheme: dark; }
        /* 커스텀 색상 */
        .status-on { color: #4ade80; } /* green-400 */
        .status-shed { color: #facc15; } /* yellow-400 */
        .status-off { color: #f87171; } /* red-400 */
        .status-fault { color: #dc2626; } /* red-600 */
        .priority-high { border-color: #f87171; } /* red-400 */
        .priority-mid { border-color: #facc15; } /* yellow-400 */
        .priority-low { border-color: #60a5fa; } /* blue-400 */
    </style>
    <!-- Inter 폰트 CDN -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- 헤더 -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-white">IoT 전력 모니터링 대시보드</h1>
            <div class="flex items-center space-x-2">
                <div id="ws-status-light" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <span id="ws-status-text" class="text-sm text-gray-400">연결 중...</span>
            </div>
        </header>

        <!-- 1. 시스템 상태 -->
        <div class="mb-6 bg-gray-800 rounded-lg shadow-lg p-4">
            <h2 class="text-lg font-semibold mb-3 text-white">시스템 상태</h2>
            <div id="system-status-box" class="text-center p-4 rounded-lg bg-gray-700">
                <span id="system-status-text" class="text-2xl font-bold text-gray-400">데이터 수신 대기 중...</span>
            </div>
        </div>

        <!-- 2. 공통 정보 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- 총 전력 -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center">
                <span class="text-sm text-gray-400">총 유효전력 (P)</span>
                <span id="p-total" class="text-3xl font-bold text-green-400">-</span>
                <span class="text-gray-400">W</span>
            </div>
            <!-- 전압 -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center">
                <span class="text-sm text-gray-400">전압 (V)</span>
                <span id="v-rms" class="text-3xl font-bold text-cyan-400">-</span>
                <span class="text-gray-400">V</span>
            </div>
            <!-- 총 역률 -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center">
                <span class="text-sm text-gray-400">총 역률 (PF)</span>
                <span id="pf-total" class="text-3xl font-bold text-orange-400">-</span>
            </div>
            <!-- THD -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center">
                <span class="text-sm text-gray-400">전압 THD</span>
                <span id="thd" class="text-3xl font-bold text-purple-400">-</span>
                <span class="text-gray-400">%</span>
            </div>
        </div>

        <!-- 3. 개별 부하 상태 -->
        <h2 class="text-lg font-semibold mb-3 text-white">개별 부하 (3-Load)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- 부하 1 (높음) -->
            <div id="load-1-card" class="bg-gray-800 rounded-lg shadow-lg p-4 border-l-4 priority-high">
                <h3 class_name="text-lg font-semibold mb-3">부하 1 (우선순위: 높음)</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">상태</span>
                    <span id="load-1-state" class="text-lg font-bold status-off">-</span>
                </div>
                <div class="space-y-2">
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전력</span>
                        <span id="load-1-p" class="font-semibold text-white">- W</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전류</span>
                        <span id="load-1-i" class="font-semibold text-white">- A</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">역률</span>
                        <span id="load-1-pf" class="font-semibold text-white">-</span>
                    </div>
                </div>
            </div>

            <!-- 부하 2 (중간) -->
            <div id="load-2-card" class="bg-gray-800 rounded-lg shadow-lg p-4 border-l-4 priority-mid">
                <h3 class_name="text-lg font-semibold mb-3">부하 2 (우선순위: 중간)</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">상태</span>
                    <span id="load-2-state" class="text-lg font-bold status-off">-</span>
                </div>
                <div class="space-y-2">
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전력</span>
                        <span id="load-2-p" class="font-semibold text-white">- W</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전류</span>
                        <span id="load-2-i" class="font-semibold text-white">- A</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">역률</span>
                        <span id="load-2-pf" class="font-semibold text-white">-</span>
                    </div>
                </div>
            </div>

            <!-- 부하 3 (낮음) -->
            <div id="load-3-card" class="bg-gray-800 rounded-lg shadow-lg p-4 border-l-4 priority-low">
                <h3 class_name="text-lg font-semibold mb-3">부하 3 (우선순위: 낮음)</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">상태</span>
                    <span id="load-3-state" class="text-lg font-bold status-off">-</span>
                </div>
                <div class="space-y-2">
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전력</span>
                        <span id="load-3-p" class="font-semibold text-white">- W</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">전류</span>
                        <span id="load-3-i" class="font-semibold text-white">- A</span>
                    </div>
                    <div class_name="flex justify-between">
                        <span class="text-gray-400">역률</span>
                        <span id="load-3-pf" class="font-semibold text-white">-</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // WebSocket 클라이언트 설정
        // ESP-01의 IP 주소로 자동 접속 시도 (ESP-01이 이 HTML을 호스팅하므로)
        const gateway = `ws://${window.location.hostname}/ws`;
        let websocket;

        // DOM 요소 캐시
        const wsStatusLight = document.getElementById('ws-status-light');
        const wsStatusText = document.getElementById('ws-status-text');
        
        const systemStatusBox = document.getElementById('system-status-box');
        const systemStatusText = document.getElementById('system-status-text');

        const pTotalEl = document.getElementById('p-total');
        const vRmsEl = document.getElementById('v-rms');
        const pfTotalEl = document.getElementById('pf-total');
        const thdEl = document.getElementById('thd');

        const loadEls = [
            { // 부하 1
                card: document.getElementById('load-1-card'),
                state: document.getElementById('load-1-state'),
                p: document.getElementById('load-1-p'),
                i: document.getElementById('load-1-i'),
                pf: document.getElementById('load-1-pf')
            },
            { // 부하 2
                card: document.getElementById('load-2-card'),
                state: document.getElementById('load-2-state'),
                p: document.getElementById('load-2-p'),
                i: document.getElementById('load-2-i'),
                pf: document.getElementById('load-2-pf')
            },
            { // 부하 3
                card: document.getElementById('load-3-card'),
                state: document.getElementById('load-3-state'),
                p: document.getElementById('load-3-p'),
                i: document.getElementById('load-3-i'),
                pf: document.getElementById('load-3-pf')
            }
        ];

        function initWebSocket() {
            console.log('WebSocket에 연결 시도 중...');
            websocket = new WebSocket(gateway);

            websocket.onopen = (event) => {
                console.log('WebSocket 연결 성공.');
                wsStatusLight.className = 'w-3 h-3 rounded-full bg-green-500';
                wsStatusText.textContent = '실시간 연결 중';
            };

            websocket.onclose = (event) => {
                console.log('WebSocket 연결 끊김. 2초 후 재시도...');
                wsStatusLight.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                wsStatusText.textContent = '연결 끊김';
                // 2초마다 재연결 시도
                setTimeout(initWebSocket, 2000);
            };

            websocket.onerror = (error) => {
                console.error('WebSocket 오류:', error);
                websocket.close(); // 오류 발생 시 onclose 트리거
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                } catch (e) {
                    console.error('수신한 JSON 파싱 오류:', e);
                }
            };
        }

        // UI 업데이트 함수
        function updateUI(data) {
            // 1. 공통 정보 업데이트
            pTotalEl.textContent = data.p_total.toFixed(0);
            vRmsEl.textContent = data.v_rms.toFixed(1);
            pfTotalEl.textContent = data.pf_total.toFixed(2);
            thdEl.textContent = data.thd.toFixed(1);

            // 2. 시스템 상태 업데이트
            let statusText = '알 수 없음';
            let statusColor = 'bg-gray-700';
            let statusTextColor = 'text-gray-400';
            
            switch(data.status) {
                case 'NORMAL':
                    statusText = '시스템 정상';
                    statusColor = 'bg-green-800';
                    statusTextColor = 'text-green-300';
                    break;
                case 'SHEDDING':
                    statusText = '부하 차단 동작 중';
                    statusColor = 'bg-yellow-800';
                    statusTextColor = 'text-yellow-300';
                    break;
                case 'TIMER_EXPIRED':
                    statusText = '타이머 만료 (전원 OFF)';
                    statusColor = 'bg-blue-800';
                    statusTextColor = 'text-blue-300';
                    break;
                case 'FAULT':
                    statusText = '과전류 오류 (수동 리셋 필요)';
                    statusColor = 'bg-red-800';
                    statusTextColor = 'text-red-300';
                    break;
            }
            systemStatusText.textContent = statusText;
            systemStatusBox.className = `text-center p-4 rounded-lg ${statusColor}`;
            systemStatusText.className = `text-2xl font-bold ${statusTextColor}`;

            // 3. 개별 부하 정보 업데이트
            data.loads.forEach((load, index) => {
                if (loadEls[index]) {
                    const el = loadEls[index];
                    el.p.textContent = `${load.p_real.toFixed(0)} W`;
                    el.i.textContent = `${load.i_rms.toFixed(1)} A`;
                    el.pf.textContent = load.pf.toFixed(2);

                    let stateText = '-';
                    let stateClass = 'status-off';
                    switch(load.state) {
                        case 'ON':
                            stateText = 'ON';
                            stateClass = 'status-on';
                            break;
                        case 'OFF':
                            stateText = 'OFF';
                            stateClass = 'status-off';
                            break;
                        case 'SHED':
                            stateText = 'SHED'; // 차단됨
                            stateClass = 'status-shed';
                            break;
                        case 'FAULT':
                            stateText = 'FAULT';
                            stateClass = 'status-fault';
                            break;
                    }
                    el.state.textContent = stateText;
                    el.state.className = `text-lg font-bold ${stateClass}`;
                }
            });
        }
        
        // Mock 데이터 (테스트용)
        function runMockData() {
             const mockData = {
                "v_rms": 219.8,
                "thd": 3.4,
                "p_total": 1250.0,
                "pf_total": 0.94,
                "status": "NORMAL", 
                "loads": [
                    { "id": 1, "p_real": 501.2, "i_rms": 2.3, "pf": 0.98, "state": "ON" },
                    { "id": 2, "p_real": 448.1, "i_rms": 1.9, "pf": 0.97, "state": "ON" },
                    { "id": 3, "p_real": 300.7, "i_rms": 1.4, "pf": 0.95, "state": "ON" }
                ]
            };
            
            // 5초 뒤 부하 차단 시뮬레이션
            setTimeout(() => {
                mockData.p_total = 1580.0;
                mockData.status = "SHEDDING";
                mockData.loads[2].state = "SHED"; // 부하 3 차단
                mockData.loads[2].p_real = 0.0;
                mockData.loads[2].i_rms = 0.0;
                updateUI(mockData);
            }, 5000);

            // 10초 뒤 과전류 오류 시뮬레이션
            setTimeout(() => {
                mockData.p_total = 2000.0;
                mockData.status = "FAULT";
                mockData.loads[0].state = "FAULT";
                mockData.loads[1].state = "FAULT";
                mockData.loads[2].state = "FAULT";
                updateUI(mockData);
            }, 10000);
        }

        // 페이지 로드 시 WebSocket 연결 시작
        window.addEventListener('load', () => {
            initWebSocket();
            // 테스트를 위해 mock 데이터를 사용하려면 아래 주석을 해제하세요.
            // runMockData(); 
            // updateUI(mockData); // 초기 Mock 데이터 로드
        });

    </script>
</body>
</html>